#include <ESP8266WiFi.h>
#include <Firebase_ESP_Client.h>

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>
#include <Servo.h>

// ---------------- WiFi & Firebase Config ----------------
#define WIFI_SSID      "suspension"
#define WIFI_PASSWORD  "123456789"

#define API_KEY        "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL   "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"
#define USER_EMAIL     "spherenexgpt@gmail.com"
#define USER_PASSWORD  "Spherenex@123"

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ---------------- Pin Mapping ----------------
// I2C (OLED)
#define I2C_SDA D2
#define I2C_SCL D1

// DHT11
#define DHTPIN   D5
#define DHTTYPE  DHT11

// Water level sensor
#define WATER_LEVEL_PIN A0

// HX710B
#define HX710B_SCK   D6
#define HX710B_DOUT  D7

// Servo
#define SERVO_PIN  D8

// Buzzer
#define BUZZER_PIN D3

// SW-420 (digital)
#define VIB_PIN    D0   // GPIO16

// ---------------- VIBRATION LOGIC (FIX) ----------------
// Most SW-420 LM393 modules are ACTIVE-LOW: LOW = vibration, HIGH = no vibration
const bool VIB_ACTIVE_LOW = true;   // keep true for your case

// Optional: small filter to avoid flicker
const int VIB_SAMPLES = 7;
const int VIB_SAMPLE_DELAY_MS = 2;
const int VIB_THRESHOLD = 4;        // majority

// ---------------- MAX SWEEP SETTINGS ----------------
const unsigned long VIB_TOTAL_MS = 6000;
const int SWEEP_MIN_ANGLE = 0;
const int SWEEP_MAX_ANGLE = 180;
const int SWEEP_STEP = 5;
const int SWEEP_STEP_DELAY_MS = 12;

// ---------------- OLED Config ----------------
#define SCREEN_WIDTH  128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// ---------------- Sensors / Objects ----------------
DHT dht(DHTPIN, DHTTYPE);
Servo myServo;

// HX710B zero offset
long hxZeroOffset = 0;

// state variables
int  currentServoValue   = 0;
bool lastVibrationState  = false;

// timing
unsigned long lastSensorUpdate = 0;
const unsigned long SENSOR_INTERVAL = 1000;

// ---------------- Vibration Read (Filtered) ----------------
bool readVibration()
{
  int activeCount = 0;

  for (int i = 0; i < VIB_SAMPLES; i++) {
    int raw = digitalRead(VIB_PIN);

    bool active;
    if (VIB_ACTIVE_LOW) active = (raw == LOW);
    else                active = (raw == HIGH);

    if (active) activeCount++;
    delay(VIB_SAMPLE_DELAY_MS);
  }

  return (activeCount >= VIB_THRESHOLD);
}

// ---------------- HX710B Functions ----------------
long readHX710B()
{
  unsigned long start = millis();
  while (digitalRead(HX710B_DOUT) == HIGH) {
    if (millis() - start > 1000) return 0;
    delay(1);
  }

  long count = 0;
  for (int i = 0; i < 24; i++) {
    digitalWrite(HX710B_SCK, HIGH);
    delayMicroseconds(1);
    count <<= 1;
    digitalWrite(HX710B_SCK, LOW);
    delayMicroseconds(1);
    if (digitalRead(HX710B_DOUT)) count++;
  }

  digitalWrite(HX710B_SCK, HIGH);
  delayMicroseconds(1);
  digitalWrite(HX710B_SCK, LOW);
  delayMicroseconds(1);

  if (count & 0x800000) count |= ~0xFFFFFF;
  return count;
}

void calibrateHX710B()
{
  const int samples = 50;
  long sum = 0;
  for (int i = 0; i < samples; i++) {
    sum += readHX710B();
    delay(20);
  }
  hxZeroOffset = sum / samples;
}

// ---------------- Buzzer ----------------
void beepBuzzer5Times()
{
  for (int i = 0; i < 5; i++) {
    digitalWrite(BUZZER_PIN, HIGH);
    delay(500);
    digitalWrite(BUZZER_PIN, LOW);
    delay(500);
  }
}

// ---------------- Servo from Firebase ----------------
void updateServoFromFirebase()
{
  if (Firebase.RTDB.getString(&fbdo, "/Suspenion/Servo")) {
    String servoStr = fbdo.stringData();

    int angle = servoStr.toInt();
    if (angle < 0)   angle = 0;
    if (angle > 180) angle = 180;

    if (angle != currentServoValue) {
      currentServoValue = angle;
      myServo.write(currentServoValue);
    }
  }
}

// ---- MAX SWEEP during vibration: 0 <-> 180 repeatedly ----
void servoVibrationMotion()
{
  unsigned long start = millis();

  while (millis() - start < VIB_TOTAL_MS) {

    for (int a = SWEEP_MIN_ANGLE; a <= SWEEP_MAX_ANGLE; a += SWEEP_STEP) {
      myServo.write(a);
      delay(SWEEP_STEP_DELAY_MS);
      if (millis() - start >= VIB_TOTAL_MS) break;
    }

    for (int a = SWEEP_MAX_ANGLE; a >= SWEEP_MIN_ANGLE; a -= SWEEP_STEP) {
      myServo.write(a);
      delay(SWEEP_STEP_DELAY_MS);
      if (millis() - start >= VIB_TOTAL_MS) break;
    }
  }

  updateServoFromFirebase();
  myServo.write(currentServoValue);
}

// ---------------- Sensor Read + Firebase + OLED ----------------
void readSensorsAndUpdate()
{
  if (!Firebase.ready()) return;

  float temperature = dht.readTemperature();
  float humidity    = dht.readHumidity();

  int waterLevelRaw = analogRead(WATER_LEVEL_PIN);

  long airPressureRaw = readHX710B();
  long airPressure = airPressureRaw - hxZeroOffset;
  if (airPressure < 0) airPressure = 0;

  // FIXED vibration read
  bool vibration = readVibration();

  Firebase.RTDB.setInt(&fbdo,   "/Suspenion/Water_level",  waterLevelRaw);
  Firebase.RTDB.setFloat(&fbdo, "/Suspenion/Air_Pressure", (float)airPressure);

  if (!isnan(temperature)) Firebase.RTDB.setFloat(&fbdo, "/Suspenion/Temperature", temperature);
  if (!isnan(humidity))    Firebase.RTDB.setFloat(&fbdo, "/Suspenion/Humidity", humidity);

  // edge detect
  if (vibration && !lastVibrationState) {
    Firebase.RTDB.setInt(&fbdo, "/Suspenion/Vibration", 1);
    Serial.println("1");
    servoVibrationMotion();
    beepBuzzer5Times();
  } else if (!vibration && lastVibrationState) {
    Firebase.RTDB.setInt(&fbdo, "/Suspenion/Vibration", 0);
  }
  lastVibrationState = vibration;

  // OLED
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);

  display.setCursor(0, 0);
  display.print("W:");
  display.print(waterLevelRaw);
  display.print(" P:");
  display.print(airPressure);

  display.setCursor(0, 16);
  display.print("T:");
  if (!isnan(temperature)) display.print(temperature, 1);
  display.print("C H:");
  if (!isnan(humidity)) display.print(humidity, 1);
  display.print("%");

  display.setCursor(0, 32);
  display.print("Servo:");
  display.print(currentServoValue);

  display.setCursor(0, 48);
  display.print("Vib:");
  display.print(vibration ? "YES" : "NO");

  display.display();
}

// ---------------- Setup ----------------
void setup()
{
  Serial.begin(9600);

  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);

  pinMode(HX710B_SCK, OUTPUT);
  pinMode(HX710B_DOUT, INPUT);

  // For SW-420 LM393 modules, DO is driven, so INPUT is correct here.
  pinMode(VIB_PIN, INPUT);

  Wire.begin(I2C_SDA, I2C_SCL);

  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.clearDisplay();
  display.display();

  dht.begin();

  myServo.attach(SERVO_PIN);
  currentServoValue = 0;
  myServo.write(currentServoValue);

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }

  config.api_key       = API_KEY;
  config.database_url  = DATABASE_URL;
  auth.user.email      = USER_EMAIL;
  auth.user.password   = USER_PASSWORD;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  calibrateHX710B();
}

// ---------------- Loop ----------------
void loop()
{
  updateServoFromFirebase();

  if (millis() - lastSensorUpdate >= SENSOR_INTERVAL) {
    lastSensorUpdate = millis();
    readSensorsAndUpdate();
  }
}
