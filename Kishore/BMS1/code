/************************************************************
 * ESP32 + DHT11 + Voltage Sensor + Current Sensor + OLED + 2-Relay + Firebase
 * Writes to Firebase RTDB node: BMS1/
 ************************************************************/

#include <Arduino.h>
#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include "DHT.h"

#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

// ================= USER CONFIG ===================
// WiFi
#define WIFI_SSID     "bms"
#define WIFI_PASSWORD "123456789"

// Firebase
#define API_KEY       "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL  "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"
#define USER_EMAIL    "spherenexgpt@gmail.com"
#define USER_PASSWORD "Spherenex@123"

// RTDB Base Path
#define BMS1_PATH "BMS1"

// ================= DHT11 CONFIG ==================
#define DHTPIN  4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// ================= OLED CONFIG ==================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define I2C_SDA 21
#define I2C_SCL 22
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// ================= RELAY CONFIG ==================
#define RELAY1_PIN 25
#define RELAY2_PIN 26
const bool RELAY_ACTIVE_LOW  = true;
const int RELAY_ON_LEVEL     = RELAY_ACTIVE_LOW ? LOW  : HIGH;
const int RELAY_OFF_LEVEL    = RELAY_ACTIVE_LOW ? HIGH : LOW;

// ================= ANALOG SENSOR CONFIG ==========
#define VOLTAGE_PIN 34
#define CURRENT_PIN 35
const float VOLTAGE_FACTOR = 25.0 / 4095.0; // Adjust according to sensor
const float CURRENT_FACTOR = 5.0 / 4095.0;  // Adjust according to sensor

// ================= FIREBASE OBJECTS ==============
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ================= TIMING ========================
unsigned long lastUpdate = 0;
const unsigned long UPDATE_INTERVAL_MS = 2000;

// ================= FUNCTIONS =====================
void setRelayState(int state){
  if(state==1){
    digitalWrite(RELAY1_PIN, RELAY_ON_LEVEL);
    digitalWrite(RELAY2_PIN, RELAY_OFF_LEVEL);
  }else if(state==2){
    digitalWrite(RELAY1_PIN, RELAY_ON_LEVEL);
    digitalWrite(RELAY2_PIN, RELAY_ON_LEVEL);
  }else{
    digitalWrite(RELAY1_PIN, RELAY_OFF_LEVEL);
    digitalWrite(RELAY2_PIN, RELAY_OFF_LEVEL);
  }
}

void showWiFiScreen(){
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.println("WiFi Config:");
  display.print("SSID: "); display.println(WIFI_SSID);
  display.print("PASS: "); display.println(WIFI_PASSWORD);
  display.display();
}

void showDataOnOLED(float temp, float hum, float voltage, float current, int relayState){
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.print("Temp: "); display.print(temp,1); display.println(" C");
  display.setCursor(0,12);
  display.print("Hum : "); display.print(hum,1); display.println(" %");
  display.setCursor(0,24);
  display.print("Volt: "); display.print(voltage,2); display.println(" V");
  display.setCursor(0,36);
  display.print("Curr: "); display.print(current,2); display.println(" A");
  display.setCursor(0,48);
  display.print("Relay: "); display.print(relayState);
  display.display();
}

// ================= SETUP =========================
void setup(){
  Serial.begin(115200);
  delay(1000);

  // GPIO
  pinMode(RELAY1_PIN, OUTPUT);
  pinMode(RELAY2_PIN, OUTPUT);
  setRelayState(0);

  // OLED
  Wire.begin(I2C_SDA, I2C_SCL);
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)){
    Serial.println("SSD1306 failed");
    while(1);
  }
  display.clearDisplay(); display.display();
  showWiFiScreen(); delay(3000);

  // DHT
  dht.begin();

  // WiFi
  WiFi.begin(WIFI_SSID,WIFI_PASSWORD);
  Serial.print("Connecting WiFi");
  while(WiFi.status()!=WL_CONNECTED){ delay(500); Serial.print("."); }
  Serial.println("\nWiFi Connected: "); Serial.println(WiFi.localIP());

  // ADC
  analogReadResolution(12);

  // Firebase
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Firebase.begin(&config,&auth);
  Firebase.reconnectWiFi(true);
  fbdo.setResponseSize(1024);

  Serial.println("Firebase ready.");
}

// ================= LOOP =========================
void loop(){
  if(!Firebase.ready()) { delay(100); return; }

  if(millis()-lastUpdate>=UPDATE_INTERVAL_MS){
    lastUpdate = millis();

    // Read sensors
    float hum = dht.readHumidity();
    float temp = dht.readTemperature();

    if(isnan(hum)||isnan(temp)){ Serial.println("DHT failed"); return; }

    float voltage = analogRead(VOLTAGE_PIN)*VOLTAGE_FACTOR;
    float current = analogRead(CURRENT_PIN)*CURRENT_FACTOR;

    // Relay logic
    int relayState = 0;
    if(temp>30) relayState=2;
    else if(temp>25) relayState=1;
    else relayState=0;
    setRelayState(relayState);

    // Debug
    Serial.printf("Temp: %.1f  Hum: %.1f  Volt: %.2f  Curr: %.2f  Relay: %d\n",
                  temp, hum, voltage, current, relayState);

    // Firebase: Write all fields at once using JSON
    FirebaseJson json;
    json.set("Temp", temp);
    json.set("Hum", hum);
    json.set("Voltage", voltage);
    json.set("Current", current);
    json.set("Relay", relayState);

    if(Firebase.RTDB.setJSON(&fbdo,BMS1_PATH,&json)){
      Serial.println("Firebase updated");
    }else{
      Serial.print("Firebase update failed: ");
      Serial.println(fbdo.errorReason());
    }

    // OLED
    showDataOnOLED(temp, hum, voltage, current, relayState);
  }
}
