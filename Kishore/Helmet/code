/************************************************************
 * ESP32 + Adafruit_MPU6050 - Impact + Pitch/Roll + Relay + Button + Buzzer
 *
 * - Relay supports ACTIVE HIGH or ACTIVE LOW using a macro.
 * - Button prints "1" once per press (Serial only).
 * - Firebase logs only:
 *      aTotal_g, pitch_deg, roll_deg, impact, relay
 * - Buzzer: toggles every 500 ms for 5 s when impact is detected.
 * - SERIAL_BUTTON_ONLY macro:
 *      1 -> only button "1" is printed to Serial
 *      0 -> full Serial telemetry and debug
 *
 * CHANGE (ONLY THIS):
 * - Relay2 (K2) controlled from Firebase:
 *      /FIREBASE_PATH/Live/Relay  == "1" (or 1)  -> Relay2 ON
 *      else                                     -> Relay2 OFF
 ************************************************************/

#include <Arduino.h>
#include <Wire.h>
#include <math.h>

// ---- Adafruit MPU6050 ----
#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>

// ---- WiFi / Firebase ----
#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

Adafruit_MPU6050 mpu;

// ========= USER CONFIG =========
// I2C pins for ESP32
#define I2C_SDA 21
#define I2C_SCL 22

// Relay pin (impact relay)
#define RELAY_PIN 5
// Relay mode: 1 = active HIGH, 0 = active LOW
#define RELAY_ACTIVE_HIGH 0    // <<< CHANGE THIS ONLY IF NEEDED

// ---------- Relay2 (K2) pin ----------
#define RELAY2_PIN 23          // <<< CHANGE to your relay module K2(IN2) GPIO
#define RELAY2_ACTIVE_HIGH 0   // <<< CHANGE THIS ONLY IF NEEDED
// ------------------------------------

// Button pin (with internal pull-up)
#define BUTTON_PIN 4

// Relay ON duration (keeping your value unchanged)
const unsigned long RELAY_ON_TIME_MS = 90000;

// Buzzer pin + behavior
#define BUZZER_PIN 18
#define BUZZER_ACTIVE_HIGH 1
const unsigned long BUZZER_TOGGLE_INTERVAL_MS = 500;
const unsigned long BUZZER_TOTAL_DURATION_MS  = 5000;

// Serial output mode
#define SERIAL_BUTTON_ONLY 1

// Sampling
const unsigned long SAMPLE_INTERVAL_MS = 10; // 100 Hz

// Impact threshold
const float IMPACT_G = 1.5f;

// ========= WiFi / Firebase CONFIG =========
#define WIFI_SSID       "helmet"
#define WIFI_PASSWORD   "123456789"

#define API_KEY         "AIzaSyBzXzocbdytn4N8vLrT-V2JYZ8pgqWrbC0"
#define DATABASE_URL    "https://self-balancing-7a9fe-default-rtdb.firebaseio.com/"
#define USER_EMAIL      "spherenexgpt@gmail.com"
#define USER_PASSWORD   "Spherenex@123"

#define FIREBASE_PATH   "80_helmet_08_12_2025"
const unsigned long FIREBASE_SEND_INTERVAL_MS = 200;

// ========= RELAY MACROS (DON'T TOUCH) =========
#if RELAY_ACTIVE_HIGH
  #define RELAY_ON()  digitalWrite(RELAY_PIN, HIGH)
  #define RELAY_OFF() digitalWrite(RELAY_PIN, LOW)
#else
  #define RELAY_ON()  digitalWrite(RELAY_PIN, LOW)
  #define RELAY_OFF() digitalWrite(RELAY_PIN, HIGH)
#endif

#if RELAY2_ACTIVE_HIGH
  #define RELAY2_ON()  digitalWrite(RELAY2_PIN, HIGH)
  #define RELAY2_OFF() digitalWrite(RELAY2_PIN, LOW)
#else
  #define RELAY2_ON()  digitalWrite(RELAY2_PIN, LOW)
  #define RELAY2_OFF() digitalWrite(RELAY2_PIN, HIGH)
#endif

// ========= BUZZER MACROS (DON'T TOUCH) =========
#if BUZZER_ACTIVE_HIGH
  #define BUZZER_ON()  digitalWrite(BUZZER_PIN, HIGH)
  #define BUZZER_OFF() digitalWrite(BUZZER_PIN, LOW)
#else
  #define BUZZER_ON()  digitalWrite(BUZZER_PIN, LOW)
  #define BUZZER_OFF() digitalWrite(BUZZER_PIN, HIGH)
#endif

// ========= SERIAL DEBUG MACROS =========
#if SERIAL_BUTTON_ONLY
  #define DBG_PRINT(...)    do {} while (0)
  #define DBG_PRINTLN(...)  do {} while (0)
#else
  #define DBG_PRINT(...)    Serial.print(__VA_ARGS__)
  #define DBG_PRINTLN(...)  Serial.println(__VA_ARGS__)
#endif

// ========= FIREBASE OBJECTS =========
FirebaseData   fbdo;
FirebaseAuth   auth;
FirebaseConfig config;
unsigned long  sendDataPrevMillis = 0;

// ========= INTERNAL STATE =========
unsigned long lastSampleTime   = 0;

// Relay1 state
bool          relayOn          = false;
unsigned long relayOnStartTime = 0;

// Relay2 state
bool relay2On = false;

// Button edge detection
int lastButtonState = HIGH;    // INPUT_PULLUP -> HIGH = not pressed

// Buzzer state
bool buzzerActive              = false;
bool buzzerState               = false;
unsigned long buzzerStartTime  = 0;
unsigned long buzzerLastToggle = 0;

// -------- WiFi helper --------
void connectWiFi() {
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  DBG_PRINT("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    DBG_PRINT(".");
  }
  DBG_PRINTLN("");
  DBG_PRINT("Connected, IP: ");
  DBG_PRINTLN(WiFi.localIP());
}

// ========= Firebase logging function =========
void sendFirebaseData(float aTotal, float pitchDeg, float rollDeg,
                      bool impact, bool relayOn) {
  unsigned long now = millis();
  if (!Firebase.ready()) return;
  if (now - sendDataPrevMillis < FIREBASE_SEND_INTERVAL_MS) return;

  sendDataPrevMillis = now;
  String base = String("/") + FIREBASE_PATH + "/Live";

  // Only these five keys in Firebase
  Firebase.RTDB.setFloat(&fbdo, base + "/aTotal_g",  aTotal);
  Firebase.RTDB.setFloat(&fbdo, base + "/pitch_deg", pitchDeg);
  Firebase.RTDB.setFloat(&fbdo, base + "/roll_deg",  rollDeg);

  int impactInt = impact ? 1 : 0;
  int relayInt  = relayOn ? 1 : 0;
  Firebase.RTDB.setInt(&fbdo, base + "/impact", impactInt);
  Firebase.RTDB.setInt(&fbdo, base + "/relay",  relayInt);
}

// ========= Relay2 control from Firebase (ONLY CHANGE) =========
void updateRelay2FromFirebase() {
  if (!Firebase.ready()) return;

  String base = String("/") + FIREBASE_PATH + "/Live";
  String key  = base + "/Relay";   // <<< IMPORTANT: capital R (Live/Relay)

  bool shouldOn = false;

  // Try reading as STRING first (because your Live/Relay looks like "" / "1")
  if (Firebase.RTDB.getString(&fbdo, key)) {
    String v = fbdo.stringData();
    v.trim();
    shouldOn = (v == "1");
  } else {
    // If not string, try INT
    if (Firebase.RTDB.getInt(&fbdo, key)) {
      int iv = fbdo.intData();
      shouldOn = (iv == 1);
    } else {
      // read failed -> keep last state (no change)
      return;
    }
  }

  if (shouldOn && !relay2On) {
    relay2On = true;
    RELAY2_ON();
    DBG_PRINTLN("Relay2 ON (Live/Relay==1)");
  } else if (!shouldOn && relay2On) {
    relay2On = false;
    RELAY2_OFF();
    DBG_PRINTLN("Relay2 OFF (Live/Relay!=1)");
  }
}
// =============================================================

void setup() {
  Serial.begin(9600);
  delay(2000);

  Serial.println("ESP32 + MPU6050 (Adafruit) Impact + Pitch/Roll + Relay + Button + Buzzer");
  Serial.println("----------------------------------------------------------------");

  // I2C init
  Wire.begin(I2C_SDA, I2C_SCL);
  Wire.setClock(400000);

  // MPU init
  if (!mpu.begin()) {
    Serial.println("MPU6050 connection: FAILED");
  } else {
    Serial.println("MPU6050 connection: OK");
  }

  mpu.setAccelerometerRange(MPU6050_RANGE_2_G);
  mpu.setGyroRange(MPU6050_RANGE_250_DEG);
  mpu.setFilterBandwidth(MPU6050_BAND_21_HZ);

  // Relay1 init
  pinMode(RELAY_PIN, OUTPUT);
  RELAY_OFF();

  // Relay2 init
  pinMode(RELAY2_PIN, OUTPUT);
  RELAY2_OFF();

  // Buzzer init
  pinMode(BUZZER_PIN, OUTPUT);
  BUZZER_OFF();

  // Button init
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  // WiFi init
  connectWiFi();

  // Firebase init
  config.api_key      = API_KEY;
  config.database_url = DATABASE_URL;
  auth.user.email     = USER_EMAIL;
  auth.user.password  = USER_PASSWORD;
  config.token_status_callback = tokenStatusCallback;

  Firebase.begin(&config, &auth);
  Firebase.reconnectNetwork(true);

  Serial.println("Waiting for Firebase token...");
  while (auth.token.uid.length() == 0) {
    Serial.print(".");
    delay(1000);
  }
  Serial.println();
  Serial.print("Firebase UID: ");
  Serial.println(auth.token.uid.c_str());
}

void loop() {
  unsigned long now = millis();

  // WiFi reconnect
  if (WiFi.status() != WL_CONNECTED) {
    DBG_PRINTLN("Wi-Fi lost. Reconnecting...");
    connectWiFi();
  }

  // Button edge detect: print "1" once per press
  int buttonReading = digitalRead(BUTTON_PIN);
  if (lastButtonState == HIGH && buttonReading == LOW) {
    Serial.println("1");
  }
  lastButtonState = buttonReading;

  // Relay1 timing
  if (relayOn && (now - relayOnStartTime >= RELAY_ON_TIME_MS)) {
    relayOn = false;
    RELAY_OFF();
    DBG_PRINTLN("Relay OFF (time completed)");
  }

  // Buzzer timing
  if (buzzerActive) {
    if (now - buzzerStartTime >= BUZZER_TOTAL_DURATION_MS) {
      buzzerActive = false;
      buzzerState  = false;
      BUZZER_OFF();
      DBG_PRINTLN("Buzzer OFF (5s completed)");
    } else if (now - buzzerLastToggle >= BUZZER_TOGGLE_INTERVAL_MS) {
      buzzerLastToggle = now;
      buzzerState = !buzzerState;
      if (buzzerState) BUZZER_ON();
      else BUZZER_OFF();
    }
  }

  // Relay2 from Firebase Live/Relay
  updateRelay2FromFirebase();

  // Sampling control
  if (now - lastSampleTime < SAMPLE_INTERVAL_MS) return;
  lastSampleTime = now;

  // Read MPU6050
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

  // Convert m/s^2 to g
  float ax_g = a.acceleration.x / 9.80665f;
  float ay_g = a.acceleration.y / 9.80665f;
  float az_g = a.acceleration.z / 9.80665f;

  // Total acceleration magnitude (g)
  float aTotal = sqrt(ax_g * ax_g + ay_g * ay_g + az_g * az_g);

  // Pitch and roll
  float pitchRad = atan2(ax_g, sqrt(ay_g * ay_g + az_g * az_g));
  float rollRad  = atan2(ay_g, sqrt(ax_g * ax_g + az_g * az_g));
  float pitchDeg = pitchRad * 180.0f / PI;
  float rollDeg  = rollRad  * 180.0f / PI;

  bool impact = (aTotal > IMPACT_G);

  // On impact: Relay1 ON + buzzer start
  if (impact && !relayOn) {
    relayOn = true;
    relayOnStartTime = now;
    RELAY_ON();
    DBG_PRINTLN("Impact detected -> Relay ON");

    buzzerActive      = true;
    buzzerStartTime   = now;
    buzzerLastToggle  = now;
    buzzerState       = true;
    BUZZER_ON();
    DBG_PRINTLN("Buzzer ON (start 5s beeping)");
  }

  // Serial telemetry (suppressed when SERIAL_BUTTON_ONLY=1)
  DBG_PRINT("aTotal[g]: ");
  DBG_PRINT(aTotal, 2);
  DBG_PRINT("  | Pitch[deg]: ");
  DBG_PRINT(pitchDeg, 1);
  DBG_PRINT("  Roll[deg]: ");
  DBG_PRINT(rollDeg, 1);
  DBG_PRINT("  | Impact: ");
  DBG_PRINT(impact ? "YES" : "NO");
  DBG_PRINT("  | Relay: ");
  DBG_PRINTLN(relayOn ? "ON" : "OFF");

  // Firebase logging (same 5 keys only)
  sendFirebaseData(aTotal, pitchDeg, rollDeg, impact, relayOn);
}
