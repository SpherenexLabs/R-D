/************************************************************
 * ESP32 - 3x3 Button Matrix + OLED + 3 Traffic LEDs + Firebase + 4 Relays
 *
 * Matrix:
 *   Rows: GPIO14, GPIO27, GPIO26
 *   Cols: GPIO25, GPIO33, GPIO32
 *
 * LEDs:
 *   Green  -> GPIO2
 *   Yellow -> GPIO4
 *   Red    -> GPIO5
 *
 * 4-Channel Relay (active LOW):
 *   IN1 -> GPIO16
 *   IN2 -> GPIO17
 *   IN3 -> GPIO18
 *   IN4 -> GPIO19
 *
 * OLED:
 *   SDA -> GPIO21
 *   SCL -> GPIO22
 *
 * Firebase RTDB path:
 *   9_button_Fault/Node      (int)
 *   9_button_Fault/Distance  (int)
 *   9_button_Fault/Row       (int)
 *   9_button_Fault/Col       (int)
 *   9_button_Fault/LED       (string)
 ************************************************************/

#include <Arduino.h>
#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

/* ========== USER CONFIG ========== */
// Wi-Fi
#define WIFI_SSID     "node"
#define WIFI_PASSWORD "123456789"

// Firebase (using your v2v project)
#define API_KEY       "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL  "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"

#define USER_EMAIL    "spherenexgpt@gmail.com"
#define USER_PASSWORD "Spherenex@123"

// Root node in RTDB
#define ROOT_NODE "9_button_Fault"

/* ========== OLED CONFIG ========== */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET    -1
#define OLED_ADDR     0x3C

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ========== MATRIX PINS ========== */
// 3x3 button matrix
const int rowPins[3] = {14, 27, 26};   // R1, R2, R3 -> outputs
const int colPins[3] = {25, 33, 32};   // C1, C2, C3 -> inputs with pullup

/* ========== TRAFFIC LIGHT LED PINS ========== */
const int GREEN_LED_PIN  = 2;   // Row1 -> Green
const int YELLOW_LED_PIN = 4;   // Row2 -> Yellow
const int RED_LED_PIN    = 5;   // Row3 -> Red

/* ========== 4-CHANNEL RELAY PINS ========== */
// Using a 4-channel relay module (ACTIVE LOW)
const int relayPins[4] = {16, 17, 18, 19};  // IN1..IN4

const bool RELAY_ACTIVE_LOW = true;         // true for most modules
#define RELAY_ON  (RELAY_ACTIVE_LOW ? LOW : HIGH)
#define RELAY_OFF (RELAY_ACTIVE_LOW ? HIGH : LOW)

/* ========== LOGIC VARIABLES ========== */
int lastNode = 0;   // 0 means no button pressed

// Distances by column index: C0 -> 10, C1 -> 100, C2 -> 1000
const int distances[3] = {10, 100, 1000};

/* Relay blinking state */
bool relaysBlinking = false;
bool relaysCurrentOn = false;
unsigned long lastBlinkMillis = 0;
const unsigned long BLINK_INTERVAL = 150;  // ms, adjust speed here

/* ========== Firebase Objects ========== */
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

bool firebaseInitialized = false;

/* ========== FUNCTION DECLARATIONS ========== */
int  scanButtons();
void setTrafficLightsByRow(int rowIndex);
void showNodeOnOLED(int node, int distance, const char *ledColor);
void showIdleOnOLED();
void showWiFiInfoOnOLED();
void initWiFi();
void initFirebase();
void updateFirebaseNoSelection();
void updateFirebaseSelection(int node, int row, int col, int distance, const char *ledColor);
void allRelaysOn();
void allRelaysOff();
void handleRelayBlink();

/* ========== SETUP ========== */
void setup() {
  Serial.begin(115200);
  delay(500);

  // I2C for OLED (ESP32 default pins: SDA=21, SCL=22)
  Wire.begin(21, 22);

  // Initialize OLED
  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
    Serial.println("SSD1306 allocation failed");
    while (true) {
      delay(1000);
    }
  }

  // 1) First 3 sec: show SSID and Password
  showWiFiInfoOnOLED();

  // 2) Then show project title briefly
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("9 Button Fault");
  display.println("3x3 Matrix +");
  display.println("Traffic LEDs +");
  display.println("4 Relays");
  display.display();
  delay(1000);

  // Setup row pins as OUTPUT, idle HIGH
  for (int r = 0; r < 3; r++) {
    pinMode(rowPins[r], OUTPUT);
    digitalWrite(rowPins[r], HIGH);
  }

  // Setup column pins as INPUT_PULLUP
  for (int c = 0; c < 3; c++) {
    pinMode(colPins[c], INPUT_PULLUP);
  }

  // Setup LEDs
  pinMode(GREEN_LED_PIN, OUTPUT);
  pinMode(YELLOW_LED_PIN, OUTPUT);
  pinMode(RED_LED_PIN, OUTPUT);
  digitalWrite(GREEN_LED_PIN, LOW);
  digitalWrite(YELLOW_LED_PIN, LOW);
  digitalWrite(RED_LED_PIN, LOW);

  // Setup 4 relays
  for (int i = 0; i < 4; i++) {
    pinMode(relayPins[i], OUTPUT);
    digitalWrite(relayPins[i], RELAY_OFF);   // all OFF at start
  }

  // Show idle screen at start
  showIdleOnOLED();

  // Init Wi-Fi + Firebase
  initWiFi();
  initFirebase();

  // Initial "no selection" update
  updateFirebaseNoSelection();
}

/* ========== OLED: Show WiFi Info First 3 Seconds ========== */
void showWiFiInfoOnOLED() {
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(0, 0);

  display.println("WiFi Info (3s):");
  display.print("SSID: ");
  display.println(WIFI_SSID);
  display.print("PASS: ");
  display.println(WIFI_PASSWORD);

  display.display();
  delay(3000);
}

/* ========== WiFi INIT ========== */
void initWiFi() {
  Serial.print("Connecting to WiFi: ");
  Serial.println(WIFI_SSID);

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  int retryCount = 0;
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    retryCount++;
    if (retryCount > 60) { // ~30 seconds
      Serial.println("\nWiFi connection failed, restarting...");
      ESP.restart();
    }
  }

  Serial.println("\nWiFi connected.");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
}

/* ========== Firebase INIT ========== */
void initFirebase() {
  Serial.println("Initializing Firebase...");

  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  // For debug messages about token
  config.token_status_callback = tokenStatusCallback;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  firebaseInitialized = true;

  Serial.println("Firebase initialized.");
}

/* ========== MATRIX SCAN FUNCTION ========== */
// Returns node number (1..9) if a button is pressed, else 0
int scanButtons() {
  int detectedNode = 0;

  for (int r = 0; r < 3; r++) {
    // Drive this row LOW, others remain HIGH
    digitalWrite(rowPins[r], LOW);
    delayMicroseconds(200); // small settle time

    for (int c = 0; c < 3; c++) {
      int state = digitalRead(colPins[c]);
      // With INPUT_PULLUP, pressed = LOW
      if (state == LOW) {
        detectedNode = r * 3 + c + 1; // Node1..Node9
        // Restore row HIGH before returning
        digitalWrite(rowPins[r], HIGH);
        return detectedNode;
      }
    }

    // Restore this row HIGH
    digitalWrite(rowPins[r], HIGH);
  }

  return 0; // no button pressed
}

/* ========== TRAFFIC LIGHT HANDLING ========== */
// rowIndex: 0 -> Row1 -> Green, 1 -> Row2 -> Yellow, 2 -> Row3 -> Red
void setTrafficLightsByRow(int rowIndex) {
  switch (rowIndex) {
    case 0: // Row1 -> Green
      digitalWrite(GREEN_LED_PIN, HIGH);
      digitalWrite(YELLOW_LED_PIN, LOW);
      digitalWrite(RED_LED_PIN, LOW);
      break;
    case 1: // Row2 -> Yellow
      digitalWrite(GREEN_LED_PIN, LOW);
      digitalWrite(YELLOW_LED_PIN, HIGH);
      digitalWrite(RED_LED_PIN, LOW);
      break;
    case 2: // Row3 -> Red
      digitalWrite(GREEN_LED_PIN, LOW);
      digitalWrite(YELLOW_LED_PIN, LOW);
      digitalWrite(RED_LED_PIN, HIGH);
      break;
    default: // safety
      digitalWrite(GREEN_LED_PIN, LOW);
      digitalWrite(YELLOW_LED_PIN, LOW);
      digitalWrite(RED_LED_PIN, LOW);
      break;
  }
}

/* ========== OLED UPDATE FUNCTIONS ========== */
void showNodeOnOLED(int node, int distance, const char *ledColor) {
  display.clearDisplay();

  display.setTextColor(SSD1306_WHITE);

  display.setTextSize(2);
  display.setCursor(0, 0);
  display.print("Node");
  display.println(node);

  display.setTextSize(1);
  display.setCursor(0, 32);
  display.print("Distance: ");
  display.print(distance);
  display.println(" meter");

  display.setCursor(0, 48);
  display.print("LED: ");
  display.println(ledColor);

  display.display();
}

void showIdleOnOLED() {
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("No node selected");
  display.println("Press any button...");
  display.display();
}

/* ========== FIREBASE UPDATE HELPERS ========== */
void updateFirebaseNoSelection() {
  if (!firebaseInitialized || !Firebase.ready()) return;

  String base = String(ROOT_NODE) + "/";

  Firebase.RTDB.setInt(&fbdo, base + "Node", 0);
  Firebase.RTDB.setInt(&fbdo, base + "Distance", 0);
  Firebase.RTDB.setInt(&fbdo, base + "Row", 0);
  Firebase.RTDB.setInt(&fbdo, base + "Col", 0);
  Firebase.RTDB.setString(&fbdo, base + "LED", "OFF");

  Serial.println("Firebase: No node selected (Node=0).");
}

void updateFirebaseSelection(int node, int row, int col, int distance, const char *ledColor) {
  if (!firebaseInitialized || !Firebase.ready()) return;

  String base = String(ROOT_NODE) + "/";

  Firebase.RTDB.setInt(&fbdo, base + "Node", node);
  Firebase.RTDB.setInt(&fbdo, base + "Distance", distance);
  Firebase.RTDB.setInt(&fbdo, base + "Row", row + 1); // store 1-based
  Firebase.RTDB.setInt(&fbdo, base + "Col", col + 1); // store 1-based
  Firebase.RTDB.setString(&fbdo, base + "LED", ledColor);

  Serial.print("Firebase updated -> Node ");
  Serial.print(node);
  Serial.print(", Distance ");
  Serial.print(distance);
  Serial.print(", Row ");
  Serial.print(row + 1);
  Serial.print(", Col ");
  Serial.print(col + 1);
  Serial.print(", LED ");
  Serial.println(ledColor);
}

/* ========== RELAY CONTROL HELPERS ========== */
void allRelaysOn() {
  for (int i = 0; i < 4; i++) {
    digitalWrite(relayPins[i], RELAY_ON);
  }
  relaysCurrentOn = true;
}

void allRelaysOff() {
  for (int i = 0; i < 4; i++) {
    digitalWrite(relayPins[i], RELAY_OFF);
  }
  relaysCurrentOn = false;
}

/* Blink handler: call every loop */
void handleRelayBlink() {
  if (!relaysBlinking) {
    // make sure they stay OFF when not blinking
    allRelaysOff();
    return;
  }

  unsigned long now = millis();
  if (now - lastBlinkMillis >= BLINK_INTERVAL) {
    lastBlinkMillis = now;
    if (relaysCurrentOn) {
      allRelaysOff();
    } else {
      allRelaysOn();
    }
  }
}

/* ========== MAIN LOOP ========== */
void loop() {
  int currentNode = scanButtons();

  if (currentNode != lastNode) {
    // State changed
    lastNode = currentNode;

    if (currentNode == 0) {
      // No button pressed -> all LEDs off, relays OFF, idle message, log to Firebase
      digitalWrite(GREEN_LED_PIN, LOW);
      digitalWrite(YELLOW_LED_PIN, LOW);
      digitalWrite(RED_LED_PIN, LOW);

      relaysBlinking = false;
      allRelaysOff(); // immediately off

      showIdleOnOLED();
      Serial.println("No node pressed");

      updateFirebaseNoSelection();
    } else {
      // Calculate row/col from node
      int index = currentNode - 1;
      int row = index / 3;   // 0,1,2
      int col = index % 3;   // 0,1,2

      int distance = distances[col]; // 10 / 100 / 1000

      const char *ledColor;
      if (row == 0)      ledColor = "Green";
      else if (row == 1) ledColor = "Yellow";
      else               ledColor = "Red";

      // Set traffic light
      setTrafficLightsByRow(row);

      // Start relay blinking
      relaysBlinking = true;
      lastBlinkMillis = millis();  // reset timer so blink starts clean
      // We can start with ON phase:
      allRelaysOn();

      // Update OLED
      showNodeOnOLED(currentNode, distance, ledColor);

      Serial.print("Pressed Node");
      Serial.print(currentNode);
      Serial.print(" (Row ");
      Serial.print(row + 1);
      Serial.print(", Col ");
      Serial.print(col + 1);
      Serial.print(") -> ");
      Serial.print(distance);
      Serial.print(" meter, LED ");
      Serial.println(ledColor);

      // Log to Firebase
      updateFirebaseSelection(currentNode, row, col, distance, ledColor);
    }
  }

  // Handle relay blinking continuously
  handleRelayBlink();

  // Small delay to slow down scanning & debounce
  delay(30);
}
