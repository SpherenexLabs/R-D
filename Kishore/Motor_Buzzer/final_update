#include <Arduino.h>
#include <ESP8266WiFi.h>
#include <Firebase_ESP_Client.h>
#include <ctype.h>

#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

// ============ WIFI CONFIG ===================
#define WIFI_SSID     "robot"
#define WIFI_PASSWORD "123456789"

// ============ FIREBASE CONFIG ================
#define API_KEY       "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL  "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"
#define USER_EMAIL    "spherenexgpt@gmail.com"
#define USER_PASSWORD "Spherenex@123"

// Firebase objects
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ============ RTDB PATHS =====================
const char* PATH_DIRECTION = "/Motor_Buzzer/direction";
const char* PATH_OBSTACLE  = "/Motor_Buzzer/Obstacle";
const char* PATH_BUZZ      = "/Motor_Buzzer/Buzz";

// ============ PIN CONFIG =====================
// Ultrasonic sensor (HC-SR04)
#define TRIG_PIN   D1      // GPIO5
#define ECHO_PIN   D2      // GPIO4  (use voltage divider on Echo)

// L293D motor driver
#define IN1        D5      // GPIO14
#define IN2        D6      // GPIO12
#define IN3        D7      // GPIO13
#define IN4        D8      // GPIO15

// Buzzer
#define BUZZER_PIN D3      // GPIO0

// --------- External LED ONLY ----------
#define EXT_LED_PIN D0      // GPIO16 (your external LED)
const bool EXT_LED_ACTIVE_LOW = false;  // D0 -> LED -> GND means ACTIVE-HIGH

// --------- Internal LED forced OFF ----------
#define INT_LED_PIN LED_BUILTIN   // usually D4/GPIO2 on NodeMCU
const bool INT_LED_ACTIVE_LOW = true;   // most ESP8266 built-in LEDs are active-low

// LED blink timing
const unsigned long LED_BLINK_INTERVAL_MS = 200;
bool extLedState = false;
unsigned long lastLedMillis = 0;

// ============ PARAMETERS =====================
const float OBSTACLE_THRESHOLD_CM = 20.0;

// Direction states
char requestedDirection = 'S';
char activeDirection    = 'S';

// Obstacle tracking
bool lastObstacle = false;

// Buzzer tracking
bool buzzActive = false;
unsigned long buzzStartMillis = 0;
const unsigned long BUZZ_DURATION_MS = 2000;

// Track Buzz node changes
int lastBuzzNodeValue = 0;

// Timing for Firebase loop
unsigned long lastFbMillis = 0;
const unsigned long FB_INTERVAL = 300;

// --------------------------------------------------
// Internal LED OFF (never blink it)
// --------------------------------------------------
void setInternalLedOff() {
  if (INT_LED_ACTIVE_LOW) digitalWrite(INT_LED_PIN, HIGH);
  else                    digitalWrite(INT_LED_PIN, LOW);
}

// --------------------------------------------------
// External LED control
// --------------------------------------------------
void setExternalLed(bool on) {
  if (EXT_LED_ACTIVE_LOW) digitalWrite(EXT_LED_PIN, on ? LOW : HIGH);
  else                    digitalWrite(EXT_LED_PIN, on ? HIGH : LOW);
}

void handleExternalLedBlink(bool shouldBlink) {
  unsigned long now = millis();

  if (!shouldBlink) {
    extLedState = false;
    setExternalLed(false);
    return;
  }

  if (now - lastLedMillis >= LED_BLINK_INTERVAL_MS) {
    lastLedMillis = now;
    extLedState = !extLedState;
    setExternalLed(extLedState);
  }
}

// --------------------------------------------------
// Ultrasonic distance
// --------------------------------------------------
float readDistanceCM() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  long duration = pulseIn(ECHO_PIN, HIGH, 25000);
  if (duration == 0) return -1.0;
  return duration * 0.0343f / 2.0f;
}

// --------------------------------------------------
// Motor control
// --------------------------------------------------
void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}

void moveForward() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void moveBackward() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
}

void moveLeft() {
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void moveRight() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH);
}

void applyDirection(char dir) {
  switch (dir) {
    case 'F': moveForward(); break;
    case 'B': moveBackward(); break;
    case 'L': moveLeft(); break;
    case 'R': moveRight(); break;
    case 'S':
    default:  stopMotors(); break;
  }
}

// --------------------------------------------------
// Start buzzer
// --------------------------------------------------
void startBuzz() {
  if (buzzActive) return;

  buzzActive = true;
  buzzStartMillis = millis();
  digitalWrite(BUZZER_PIN, HIGH);

  Firebase.RTDB.setInt(&fbdo, PATH_BUZZ, 1);
  lastBuzzNodeValue = 1;
}

// --------------------------------------------------
// Setup
// --------------------------------------------------
void setup() {
  Serial.begin(115200);
  Serial.println();
  Serial.println("External LED (D0) blink on Obstacle OR Buzz; Internal LED forced OFF");

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);

  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);

  // External LED
  pinMode(EXT_LED_PIN, OUTPUT);
  setExternalLed(false);

  // Internal LED forced OFF
  pinMode(INT_LED_PIN, OUTPUT);
  setInternalLedOff();

  stopMotors();

  // WiFi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    // keep internal LED OFF always
    setInternalLedOff();
  }

  // Firebase
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  auth.user.email    = USER_EMAIL;
  auth.user.password = USER_PASSWORD;
  config.token_status_callback = tokenStatusCallback;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  // Initialize defaults
  Firebase.RTDB.setString(&fbdo, PATH_DIRECTION, "S");
  Firebase.RTDB.setInt(&fbdo, PATH_OBSTACLE, 0);
  Firebase.RTDB.setInt(&fbdo, PATH_BUZZ, 0);
}

// --------------------------------------------------
// Loop
// --------------------------------------------------
void loop() {
  unsigned long now = millis();

  // Always keep internal LED OFF
  setInternalLedOff();

  // 0) Handle buzzer timeout
  if (buzzActive && (now - buzzStartMillis >= BUZZ_DURATION_MS)) {
    digitalWrite(BUZZER_PIN, LOW);
    buzzActive = false;

    if (Firebase.ready()) {
      Firebase.RTDB.setInt(&fbdo, PATH_BUZZ, 0);
    }
    lastBuzzNodeValue = 0;
  }

  // External LED blink when obstacle OR buzzer is active
  handleExternalLedBlink(buzzActive || lastObstacle);

  // Throttle Firebase operations
  if (!Firebase.ready()) return;
  if (now - lastFbMillis < FB_INTERVAL) return;
  lastFbMillis = now;

  // 1) Read direction
  if (Firebase.RTDB.getString(&fbdo, PATH_DIRECTION)) {
    String d = fbdo.stringData();
    if (d.length() > 0) {
      char c = toupper(d.charAt(0));
      if (c == 'F' || c == 'B' || c == 'L' || c == 'R' || c == 'S') {
        requestedDirection = c;
      }
    }
  }

  // 2) Read Buzz node (manual trigger)
  int buzzNodeValue = lastBuzzNodeValue;
  if (Firebase.RTDB.getInt(&fbdo, PATH_BUZZ)) {
    buzzNodeValue = fbdo.intData();
  }

  // Rising edge trigger
  if (buzzNodeValue == 1 && lastBuzzNodeValue == 0) {
    startBuzz();
  }
  lastBuzzNodeValue = buzzNodeValue;

  // 3) Ultrasonic & obstacle
  float distance = readDistanceCM();
  bool obstacleNow = (distance > 0 && distance <= OBSTACLE_THRESHOLD_CM);

  if (obstacleNow != lastObstacle) {
    lastObstacle = obstacleNow;
    Firebase.RTDB.setInt(&fbdo, PATH_OBSTACLE, obstacleNow ? 1 : 0);

    if (obstacleNow) {
      startBuzz();
    }
  }

  // 4) Direction control
  if (requestedDirection != activeDirection) {
    applyDirection(requestedDirection);
    activeDirection = requestedDirection;
  }

  delay(10);
}
