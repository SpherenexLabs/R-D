/*
   ESP8266 + Voltage Sensor + OLED + DHT11 + Fan (direct 3.3V)

   Firebase RTDB Path:

   Solar_power
      ├─ Fan        : "ON"
      ├─ Voltage
      │    ├─ F_vol : 3.3
      │    └─ S_vol : <solar voltage>
      └─ DHT
           ├─ Temperature : <deg C>
           └─ Humidity    : <percent>

   Wiring:
   - Voltage sensor OUT  -> A0
   - OLED SDA -> D2, SCL -> D1, VCC -> 3.3V, GND -> GND
   - DHT11 DATA -> D5, VCC -> 3.3V, GND -> GND
   - Fan -> 3.3V and GND (no GPIO)
*/

#include <Arduino.h>
#include <ESP8266WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

#include <DHT.h>

// ================== WIFI CONFIG =====================
#define WIFI_SSID       "solar"
#define WIFI_PASSWORD   "123456789"

// ================== FIREBASE CONFIG =================
#define API_KEY         "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL    "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"

#define USER_EMAIL      "spherenexgpt@gmail.com"
#define USER_PASSWORD   "Spherenex@123"

// Firebase objects
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ================== PINS ============================
#define VOLTAGE_PIN   A0        // from voltage sensor
#define DHTPIN        D5        // DHT11 data pin

// ================== DHT11 SETUP =====================
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// ================== OLED SETUP ======================
#define SCREEN_WIDTH  128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// ================== MEASUREMENT CONFIG ==============
const float FIXED_F_VOL = 3.3;   // F_vol is always 3.3 V
const float VOLTAGE_MAX = 25.0;  // adjust for your voltage divider (0–25 V typical)

// Timing
unsigned long lastUpdate = 0;
const unsigned long UPDATE_INTERVAL = 2000;  // 2 seconds

// ----------------------------------------------------
void connectWiFi() {
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("WiFi connected, IP: ");
  Serial.println(WiFi.localIP());
}

// ----------------------------------------------------
void setup() {
  Serial.begin(115200);
  delay(1000);

  // I2C for OLED  (SDA=D2, SCL=D1)
  Wire.begin(D2, D1);

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("SSD1306 allocation failed");
    for (;;);
  }
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println("Solar Power Monitor");
  display.display();

  // Start DHT11
  dht.begin();

  // WiFi
  connectWiFi();

  // Firebase configuration
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Firebase.reconnectWiFi(true);
  fbdo.setResponseSize(4096);

  Firebase.begin(&config, &auth);

  Serial.println("Firebase initialized");
}

// ----------------------------------------------------
void updateOLED(float fVol, float sVol,
                float temperature, float humidity,
                const String &fanStatus) {
  display.clearDisplay();
  display.setCursor(0, 0);
  display.setTextSize(1);

  display.println("Solar Power Monitor");
  display.println("-------------------");

  display.print("F_vol: ");
  display.print(fVol, 2);
  display.println(" V");

  display.print("S_vol: ");
  display.print(sVol, 2);
  display.println(" V");

  display.print("Temp : ");
  display.print(temperature, 1);
  display.println(" C");

  display.print("Hum  : ");
  display.print(humidity, 1);
  display.println(" %");

  display.print("Fan  : ");
  display.println(fanStatus);

  display.display();
}

// ----------------------------------------------------
void loop() {
  if (Firebase.ready() && (millis() - lastUpdate > UPDATE_INTERVAL)) {
    lastUpdate = millis();

    // 1) Read solar voltage
    int raw = analogRead(VOLTAGE_PIN);
    float sVol = (raw / 1023.0) * VOLTAGE_MAX;
    float fVol = FIXED_F_VOL;

    // 2) Read DHT11
    float humidity = dht.readHumidity();
    float temperature = dht.readTemperature();  // Celsius

    if (isnan(humidity) || isnan(temperature)) {
      Serial.println("Failed to read from DHT11 sensor!");
      // You can choose to skip Firebase update for DHT here
      humidity = -1;
      temperature = -1;
    }

    // Fan is hard-wired to 3.3V, so it's always ON
    String fanStatus = "ON";

    // ---- Serial monitor ----
    Serial.println("--------- Solar_power Update ---------");
    Serial.print("Raw ADC: "); Serial.println(raw);
    Serial.print("F_vol : "); Serial.print(fVol, 2); Serial.println(" V");
    Serial.print("S_vol : "); Serial.print(sVol, 2); Serial.println(" V");
    Serial.print("Temp  : "); Serial.print(temperature, 1); Serial.println(" C");
    Serial.print("Hum   : "); Serial.print(humidity, 1); Serial.println(" %");
    Serial.print("Fan   : "); Serial.println(fanStatus);
    Serial.println("--------------------------------------");

    // ---- Firebase updates ----
    // Voltage
    if (!Firebase.RTDB.setFloat(&fbdo, "/Solar_power/Voltage/F_vol", fVol)) {
      Serial.print("Failed to set F_vol: ");
      Serial.println(fbdo.errorReason());
    }

    if (!Firebase.RTDB.setFloat(&fbdo, "/Solar_power/Voltage/S_vol", sVol)) {
      Serial.print("Failed to set S_vol: ");
      Serial.println(fbdo.errorReason());
    }

    // DHT data
    if (!Firebase.RTDB.setFloat(&fbdo, "/Solar_power/DHT/Temperature", temperature)) {
      Serial.print("Failed to set Temperature: ");
      Serial.println(fbdo.errorReason());
    }

    if (!Firebase.RTDB.setFloat(&fbdo, "/Solar_power/DHT/Humidity", humidity)) {
      Serial.print("Failed to set Humidity: ");
      Serial.println(fbdo.errorReason());
    }

    // Fan status
    if (!Firebase.RTDB.setString(&fbdo, "/Solar_power/Fan", fanStatus)) {
      Serial.print("Failed to set Fan: ");
      Serial.println(fbdo.errorReason());
    }

    // ---- OLED ----
    updateOLED(fVol, sVol, temperature, humidity, fanStatus);
  }
}
