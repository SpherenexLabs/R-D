/************************************************************
 * ESP32 + DHT11 + Voltage Sensor + Current Sensor + OLED + 2-Relay + Firebase
 *
 * Firebase RTDB structure:
 *   BMS/
 *     Temp    (float, °C)
 *     Hum     (float, %RH)
 *     Voltage (float, V)
 *     Current (float, A)
 *     Relay   (int: 0,1,2)
 *
 * Relay Logic (based on Temp):
 *   Temp <= 25°C      -> Relay1 OFF, Relay2 OFF, Relay = 0
 *   25 < Temp <= 30°C -> Relay1 ON,  Relay2 OFF, Relay = 1
 *   Temp > 30°C       -> Relay1 ON,  Relay2 ON,  Relay = 2
 *
 * OLED:
 *   - First 3 seconds: show WiFi SSID and password
 *   - Then continuously show:
 *       Temp:
 *       Hum:
 *       Voltage:
 *       Current:
 *       Relay:
 ************************************************************/

#include <Arduino.h>
#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

#include "DHT.h"

// ================== USER CONFIG ===================
// ============ WIFI CONFIG ===================
#define WIFI_SSID     "bms"        // change if needed
#define WIFI_PASSWORD "123456789"   // change if needed

// ============ FIREBASE CONFIG ================
#define API_KEY       "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL  "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"

#define USER_EMAIL    "spherenexgpt@gmail.com"
#define USER_PASSWORD "Spherenex@123"

// RTDB base path
const char* BMS_PATH = "BMS";

// ================== DHT11 CONFIG ==================
#define DHTPIN  4        // GPIO4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// ================== OLED CONFIG ===================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// I2C pins for ESP32
#define I2C_SDA 21
#define I2C_SCL 22

// ================== RELAY CONFIG ==================
// 2-channel relay module
#define RELAY1_PIN 25   // GPIO25
#define RELAY2_PIN 26   // GPIO26

// Most relay modules are ACTIVE LOW (IN = LOW -> ON)
const bool RELAY_ACTIVE_LOW  = true;
const int  RELAY_ON_LEVEL    = RELAY_ACTIVE_LOW ? LOW  : HIGH;
const int  RELAY_OFF_LEVEL   = RELAY_ACTIVE_LOW ? HIGH : LOW;

// ================== ANALOG SENSORS ================
// Separate analog inputs for ESP32
#define VOLTAGE_PIN 34   // GPIO34 (input only)
#define CURRENT_PIN 35   // GPIO35 (input only)

// ESP32 ADC: 0–4095 for 0–3.3V
// Example calibration constants (YOU MUST CALIBRATE):
// If your voltage sensor maps 0–25V to 0–3.3V:
//   factor ≈ 25 / 4095
const float VOLTAGE_FACTOR = 25.0 / 4095.0;  // adjust after calibration

// For current sensor, e.g., 0–5A mapped 0–3.3V:
//   factor ≈ 5 / 4095 (if your module is linear)
// Adjust as per your sensor’s datasheet.
const float CURRENT_FACTOR = 5.0 / 4095.0;   // adjust after calibration

// ================== FIREBASE OBJECTS ==============
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ================== TIMING ========================
unsigned long lastUpdate = 0;
const unsigned long UPDATE_INTERVAL_MS = 2000;  // 2 seconds

// ================== FUNCTIONS =====================

void setRelayState(int state) {
  // state: 0=all OFF, 1=Relay1 ON, 2=Relay1+Relay2 ON
  if (state == 1) {
    digitalWrite(RELAY1_PIN, RELAY_ON_LEVEL);
    digitalWrite(RELAY2_PIN, RELAY_OFF_LEVEL);
  } else if (state == 2) {
    digitalWrite(RELAY1_PIN, RELAY_ON_LEVEL);
    digitalWrite(RELAY2_PIN, RELAY_ON_LEVEL);
  } else {
    digitalWrite(RELAY1_PIN, RELAY_OFF_LEVEL);
    digitalWrite(RELAY2_PIN, RELAY_OFF_LEVEL);
  }
}

void showWiFiScreen() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println("WiFi Config:");
  display.print("SSID: ");
  display.println(WIFI_SSID);
  display.print("PASS: ");
  display.println(WIFI_PASSWORD);
  display.display();
}

void showDataOnOLED(float temp, float hum, float voltage, float current, int relayState) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);

  display.setCursor(0, 0);
  display.print("Temp: ");
  display.print(temp, 1);
  display.println(" C");

  display.setCursor(0, 12);
  display.print("Hum : ");
  display.print(hum, 1);
  display.println(" %");

  display.setCursor(0, 24);
  display.print("Volt: ");
  display.print(voltage, 2);
  display.println(" V");

  display.setCursor(0, 36);
  display.print("Curr: ");
  display.print(current, 2);
  display.println(" A");

  display.setCursor(0, 48);
  display.print("Relay: ");
  display.print(relayState);
  display.display();
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  // ------------ GPIO -------------
  pinMode(RELAY1_PIN, OUTPUT);
  pinMode(RELAY2_PIN, OUTPUT);
  setRelayState(0);  // all OFF

  // ------------ I2C + OLED -------------
  Wire.begin(I2C_SDA, I2C_SCL);
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("SSD1306 allocation failed");
    for (;;);
  }
  display.clearDisplay();
  display.display();

  // Show WiFi credentials for first 3 seconds
  showWiFiScreen();
  delay(3000);

  // ------------ DHT --------------
  dht.begin();

  // ------------ WiFi -------------
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("Connected. IP: ");
  Serial.println(WiFi.localIP());

  // ------------ ADC --------------
  analogReadResolution(12);  // 0–4095
  // (Optional) analogSetAttenuation(ADC_11db) if you want larger input range

  // ------------ Firebase ---------
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  Serial.println("Signing in to Firebase...");
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  Serial.println("Firebase ready.");
}

void loop() {
  if (!Firebase.ready()) {
    return;
  }

  if (millis() - lastUpdate >= UPDATE_INTERVAL_MS) {
    lastUpdate = millis();

    // ======= Read DHT11 =======
    float hum  = dht.readHumidity();
    float temp = dht.readTemperature(); // °C

    if (isnan(hum) || isnan(temp)) {
      Serial.println("Failed to read from DHT sensor!");
      return;
    }

    // ======= Read Analog Sensors =======
    int rawVolt   = analogRead(VOLTAGE_PIN);
    int rawCurr   = analogRead(CURRENT_PIN);

    float voltage = rawVolt * VOLTAGE_FACTOR;
    float current = rawCurr * CURRENT_FACTOR;

    // ======= Relay Logic based on Temp =======
    int relayState = 0;
    if (temp > 30.0) {
      relayState = 2;  // both ON
    } else if (temp > 25.0) {
      relayState = 1;  // only Relay1 ON
    } else {
      relayState = 0;  // all OFF
    }

    setRelayState(relayState);

    // ======= Debug Serial =======
    Serial.print("Temp: "); Serial.print(temp);
    Serial.print("  Hum: "); Serial.print(hum);
    Serial.print("  Voltage: "); Serial.print(voltage);
    Serial.print("  Current: "); Serial.print(current);
    Serial.print("  Relay: "); Serial.println(relayState);

    // ======= Update Firebase RTDB =======
    String base = String(BMS_PATH) + "/";

    Firebase.RTDB.setFloat(&fbdo, base + "Temp", temp);
    Firebase.RTDB.setFloat(&fbdo, base + "Hum", hum);
    Firebase.RTDB.setFloat(&fbdo, base + "Voltage", voltage);
    Firebase.RTDB.setFloat(&fbdo, base + "Current", current);
    Firebase.RTDB.setInt(&fbdo,   base + "Relay", relayState);

    // ======= Update OLED =======
    showDataOnOLED(temp, hum, voltage, current, relayState);
  }
}
