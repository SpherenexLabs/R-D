/************************************************************
 * ESP8266 + L293D + 1st Channel of 2-Channel Relay + Firebase RTDB
 *
 * Firebase RTDB structure:
 *   /Fire/direction -> "F","b","L","R","S"
 *   /Fire/Relay     -> 0 or 1
 *
 * Direction commands:
 *   F -> Forward
 *   b/B -> Backward
 *   L -> Left
 *   R -> Right
 *   S -> Stop
 *
 * Relay:
 *   1 -> Relay 1 ON
 *   0 -> Relay 1 OFF
 *
 * Required libraries:
 *   - ESP8266 board package
 *   - Firebase_ESP_Client (by Mobizt)
 *   - ArduinoJson (dependency of Firebase_ESP_Client)
 ************************************************************/

#include <Arduino.h>
#include <ESP8266WiFi.h>

#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"   // from Firebase_ESP_Client examples
#include "addons/RTDBHelper.h"    // from Firebase_ESP_Client examples

// ---------- WiFi Credentials ----------
#define WIFI_SSID     "fire"
#define WIFI_PASSWORD "123456789"

// ---------- Firebase Config ----------
#define API_KEY       "AIzaSyAXHnvNZkb00PXbG5JidbD4PbRgf7l6Lgg"
#define DATABASE_URL  "https://v2v-communication-d46c6-default-rtdb.firebaseio.com/"

// Optional user login (same as your usual projects)
#define USER_EMAIL    "spherenexgpt@gmail.com"
#define USER_PASSWORD "Spherenex@123"

// ---------- Firebase Objects ----------
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// Paths in RTDB
const char* PATH_DIRECTION = "/Fire/direction";
const char* PATH_RELAY     = "/Fire/Relay";

// ---------- L293D Motor Pins ----------
const int IN1 = D1;  // Left motor
const int IN2 = D2;
const int IN3 = D5;  // Right motor
const int IN4 = D6;

// ---------- 2-Channel Relay (ONLY 1st CHANNEL USED) ----------
const int RELAY1_PIN = D7;   // Relay channel 1 control pin

// If your relay module is ACTIVE LOW: LOW = ON, HIGH = OFF
const int RELAY_ON  = LOW;
const int RELAY_OFF = HIGH;

// ---------- Misc ----------
unsigned long lastReadMillis = 0;
const unsigned long READ_INTERVAL = 200; // ms

// =======================================================
// Motor helper functions
// =======================================================

void stopMotors() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}

void moveForward() {
  // Left motor forward
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  // Right motor forward
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void moveBackward() {
  // Left motor backward
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  // Right motor backward
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

void turnLeft() {
  // Left motor backward
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  // Right motor forward
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void turnRight() {
  // Left motor forward
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  // Right motor backward
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

// Relay control â€“ ONLY Relay 1
void setRelay1(bool on) {
  if (on) {
    digitalWrite(RELAY1_PIN, RELAY_ON);
  } else {
    digitalWrite(RELAY1_PIN, RELAY_OFF);
  }
}

// =======================================================
// Setup
// =======================================================

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println();
  Serial.println("ESP8266 + L293D + Relay1 + Firebase (Fire node)");

  // --- Pin Modes ---
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  pinMode(RELAY1_PIN, OUTPUT);

  // Default states
  stopMotors();
  setRelay1(false);

  // --- WiFi ---
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println();
  Serial.print("Connected. IP: ");
  Serial.println(WiFi.localIP());

  // --- Firebase Config ---
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  // Sign in with email & password
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;

  // Token status (debug)
  config.token_status_callback = tokenStatusCallback;

  // Initialize Firebase
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  // Optional: create default values in RTDB if they don't exist
  if (Firebase.ready()) {
    if (!Firebase.RTDB.getString(&fbdo, PATH_DIRECTION)) {
      Serial.println("direction not found, creating default 'S'");
      Firebase.RTDB.setString(&fbdo, PATH_DIRECTION, "S");
    }
    if (!Firebase.RTDB.getInt(&fbdo, PATH_RELAY)) {
      Serial.println("Relay not found, creating default 0");
      Firebase.RTDB.setInt(&fbdo, PATH_RELAY, 0);
    }
  }
}

// =======================================================
// Main Loop
// =======================================================

void loop() {
  if (!Firebase.ready()) {
    return;
  }

  unsigned long now = millis();
  if (now - lastReadMillis < READ_INTERVAL) {
    return;
  }
  lastReadMillis = now;

  // -------- Read direction --------
  if (Firebase.RTDB.getString(&fbdo, PATH_DIRECTION)) {
    if (fbdo.dataType() == "string") {
      String dir = fbdo.stringData();
      dir.trim();

      if (dir.length() > 0) {
        char cmd = dir.charAt(0);
        char cmdUpper = toupper(cmd);

        Serial.print("Direction command: ");
        Serial.println(cmd);

        switch (cmdUpper) {
          case 'F':
            moveForward();
            break;
          case 'B': // covers 'b' or 'B'
            moveBackward();
            break;
          case 'L':
            turnLeft();
            break;
          case 'R':
            turnRight();
            break;
          case 'S':
          default:
            stopMotors();
            break;
        }
      } else {
        stopMotors();
      }
    }
  } else {
    Serial.print("Failed to read direction: ");
    Serial.println(fbdo.errorReason());
  }

  // -------- Read Relay (ONLY Relay 1) --------
  if (Firebase.RTDB.getInt(&fbdo, PATH_RELAY)) {
    if (fbdo.dataType() == "int") {
      int relayVal = fbdo.intData();
      Serial.print("Relay value: ");
      Serial.println(relayVal);

      if (relayVal == 1) {
        setRelay1(true);   // Turn ON Relay 1
      } else {
        setRelay1(false);  // Turn OFF Relay 1
      }
    }
  } else {
    Serial.print("Failed to read Relay: ");
    Serial.println(fbdo.errorReason());
  }
}
